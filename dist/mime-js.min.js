(function(){window.Mime=function(){var e,t,n,r,u;return u=function(e){var t,n,r,u,a,o,i,c,s,l,p,d,f,m,g,h;return f=function(e){var t,n,r,u;return t=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,u=e.replace(t,'<a href="$1" target="_blank">$1</a>'),n=/(^|[^\/])(www\.[\S]+(\b|$))/gim,u=u.replace(n,'$1<a href="http://$2" target="_blank">$2</a>'),r=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,u=u.replace(r,'<a href="mailto:$1">$1</a>')},p=function(){var e;return e=function(){return Math.random().toString(36).slice(2)},e()+e()},s=function(e){return null==e&&(e=""),"\nContent-Type: text/plain; charset=UTF-8\nContent-Transfer-Encoding: base64\n\n"+Base64.encode(e,!0).replace(/.{76}/g,"$&\n")},i=function(e){var t;return t=e.body||"",t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/,"&gt;").replace(/\n/g,"\n<br/>"),t=f(t),t="<div>"+t+"</div>","\nContent-Type: text/html; charset=UTF-8\nContent-Transfer-Encoding: base64\n\n"+Base64.encode(t,!0).replace(/.{76}/g,"$&\n")},u=function(e,t){var n;return n=p(),"\nContent-Type: multipart/alternative; boundary="+n+"\n\n--"+n+e+"\n\n--"+n+t+"\n\n--"+n+"--"},o=function(e){var t,n,r,u,a,o,i,c;if(e){for(r=[],a=0,o=e.length;o>a;a++)n=e[a],c=n.type,i=n.name,t=n.base64,u=p(),r.push("\nContent-Type: "+c+'; name="'+i+'"\nContent-Transfer-Encoding: base64\nContent-ID: <'+u+">\nX-Attachment-Id: "+u+"\n\n"+t);return r}},l=function(e,t){var n,r,u,a,o;for(null==t&&(t=[]),n=p(),o="\nContent-Type: multipart/related; boundary="+n+"\n\n--"+n+e,u=0,a=t.length;a>u;u++)r=t[u],o+="\n--"+n+r;return o+"\n--"+n+"--"},a=function(e){var t,n,r,u,a,o,i,c;if(e){for(i=[],u=0,a=e.length;a>u;u++)t=e[u],c=t.type,o=t.name,n=t.base64,r=p(),i.push("\nContent-Type: "+c+'; name="'+o+'"\nContent-Disposition: attachment; filename="'+o+'"\nContent-Transfer-Encoding: base64\nX-Attachment-Id: '+r+"\n\n"+n);return i}},c=function(t,n){var r,u,a,o,i,c,s,l;for(u=p(),l="",e.subject&&(l="=?UTF-8?B?"+Base64.encode(e.subject,!0)+"?="),c="=?UTF-8?B?"+Base64.encode(e.fromName||"",!0)+"?=",a=(new Date).toGMTString().replace(/GMT|UTC/gi,"+0000"),s="MIME-Version: 1.0\nDate: "+a+"\nMessage-ID: <"+p()+"@mail.your-domain.com>\nSubject: "+l+"\nFrom: "+c+" <"+e.from+">\nTo: "+e.to+"\nContent-Type: multipart/mixed; boundary="+u+"\n\n--"+u+t,o=0,i=n.length;i>o;o++)r=n[o],s+="\n--"+u+r;return(s+"\n--"+u+"--").replace(/\n/g,"\r\n")},m=s(e.body),d=i(e),t=u(m,d),r=o(e.cids),g=l(t,r),n=a(e.attaches),h=c(g,n)},e=function(e){var n,r,u,a,o,i,c;n=function(e){var r,u,a,o,i,c,s,l,p,d,f,m,g,h,b,y;if(l=e.indexOf("\r\n\r\n"),-1===l&&(e=e.replace(/\n/g,"\r\n"),l=e.indexOf("\r\n\r\n"),-1===l&&(l=e.length)),d=e.slice(0,l).replace(/\r\n\s+/g," ")+"\r\n",p=e.slice(l).replace(/(\r\n)+$/,"").replace(/^(\r\n)+/,""),c="",h=d.match(/Content-Type: (.*)/i),h&&h.length>0?c=h[1]:console.log("Warning: MailParser: Content-type doesn't exist!"),s=c.split(";"),m=s[0].replace(/\s/g,""),g=m.split("/"),"multipart"===g[0].toLowerCase())for(o=[],f=s[1].match(/boundary="?([^"]*)"?/i),!f&&s[2]&&(f=s[2].match(/boundary="?([^"]*)"?/i)),i=t.trim(f[1]).replace(/"/g,""),r=i.replace(/\+/g,"\\+"),b=new RegExp("--"+r,"g"),o=p.replace(b,i).replace(b,i).split(i),o.shift(),o.pop(),u=0;u<o.length;)o[u]=o[u].replace(/(\r\n)+$/,"").replace(/^(\r\n)+/,""),o[u]=n(o[u]),u++;else if(a=p,"text"===g[0]&&(a=a.replace(RegExp("=\\r\\n","g"),""),y=a.match(RegExp("=[A-F0-9][A-F0-9]","g"))))for(u=0;u<y.length;)a=a.replace(y[u],String.fromCharCode(parseInt(y[u].replace(RegExp("="),""),16))),u++;return{rawHeaders:d,rawBody:p,body:a,contentType:c,contentTypeParts:s,boundary:i,bodyParts:o,mimeType:m,mimeTypeParts:g}},a="";try{a=n(e)}catch(s){}return o=a.rawHeaders,u=function(e){return null==e&&(e=[]),e[1]||""},i=u(/\r\nSubject: (.*)\r\n/g.exec(o)),c=u(/\r\nTo: (.*)\r\n/g.exec(o)),r=u(/\r\nFrom: (.*)\r\n/g.exec(o)),{messageParts:a,subject:i,to:c,from:r}},t=function(){var e,n,r,u,a,o,i,c;return i=function(e){return null==e&&(e=""),("function"==typeof e.trim?e.trim():void 0)||e.replace(/^\s+|\s+$/g,"")},u=function(t,n){var r;return null==t&&(t=""),null==n&&(n=""),n=n.toLowerCase(),r=function(){switch(!1){case-1===n.indexOf("koi8-r"):return e(t);case-1===n.indexOf("utf-8"):return Base64._utf8_decode(t);case-1===n.indexOf("windows-1251"):return c(t);default:return t}}()},n=function(e){return e.replace(/\=[\r\n]+/g,"").replace(/\=[0-9A-F]{2}/gi,function(e){return String.fromCharCode(parseInt(e.substr(1),16))})},e=function(e){var t,n,r,u,a,o,i;for(t=unescape("%u2500%u2502%u250C%u2510%u2514%u2518%u251C%u2524%u252C%u2534%u253C%u2580%u2584%u2588%u258C%u2590%u2591%u2592%u2593%u2320%u25A0%u2219%u221A%u2248%u2264%u2265%u00A0%u2321%u00B0%u00B2%u00B7%u00F7%u2550%u2551%u2552%u0451%u2553%u2554%u2555%u2556%u2557%u2558%u2559%u255A%u255B%u255C%u255D%u255E%u255F%u2560%u2561%u0401%u2562%u2563%u2564%u2565%u2566%u2567%u2568%u2569%u256A%u256B%u256C%u00A9%u044E%u0430%u0431%u0446%u0434%u0435%u0444%u0433%u0445%u0438%u0439%u043A%u043B%u043C%u043D%u043E%u043F%u044F%u0440%u0441%u0442%u0443%u0436%u0432%u044C%u044B%u0437%u0448%u044D%u0449%u0447%u044A%u042E%u0410%u0411%u0426%u0414%u0415%u0424%u0413%u0425%u0418%u0419%u041A%u041B%u041C%u041D%u041E%u041F%u042F%u0420%u0421%u0422%u0423%u0416%u0412%u042C%u042B%u0417%u0428%u042D%u0429%u0427%u042A"),n=function(e){return e>=128&&255>=e?t.charAt(e-128):String.fromCharCode(e)},o="",r=u=0,a=e.length;a>u;r=++u)i=e[r],o+=n(e.charCodeAt(r));return o},c=function(e){var t,n,r,u,a,o,i;for(null==e&&(e=""),o="",t=r=0,u=e.length;u>r;t=++r)i=e[t],n=e.charCodeAt(t),a=function(){switch(!1){case 168!==n:return 1025;case 184!==n:return 1105;case!(n>191&&256>n):return n+848;default:return n}}(),o+=String.fromCharCode(a);return o},r=function(e,r){var a,o,i;return e=t.trim(e),o=void 0,a=void 0,i=void 0,(i=e.match(/^\=\?([\w_\-]+)\?([QqBb])\?([^\?]*)\?\=$/i))?(o=i[1],a=(i[2]||"Q").toString().toUpperCase(),e=(i[3]||"").replace(/_/g," "),"B"===a?Base64.decode(e,r):"Q"===a?n(e):e):u(e,r)},a=function(e,t){return e=(e||"").toString().replace(/(=\?[^?]+\?[QqBb]\?[^?]+\?=)\s+(?==\?[^?]+\?[QqBb]\?[^?]*\?=)/g,"$1").replace(/\=\?([\w_\-]+)\?([QqBb])\?[^\?]*\?\=/g,function(e,t,n){return r(e)}.bind(this)),u(e,t)},o=function(e){return null==e&&(e=""),(e+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},{decode:u,KOIRDec:e,win1251Dec:c,decodeMimeWords:a,toHtmlEntity:o,trim:i}}(),n=function(n){var u,a,o,i,c,s,l,p,d,f,m,g;f={html:"",text:"",attaches:[],innerMsgs:[],to:t.decodeMimeWords(n.to),from:t.decodeMimeWords(n.from),subject:t.decodeMimeWords(n.subject)},a=function(e,n){var r,u,a;return a=/Content-Transfer-Encoding: quoted-printable/i.test(n),u=/Content-Transfer-Encoding: base64/i.test(n),u?(e=e.replace(/\s/g,""),r="function"==typeof atob?atob(e):void 0,null==r&&(r=Base64.decode(e)),e=r):a&&(e=t.QPDec(e)),e},p=function(n){var u,o,i,c,s,l,d,m,g,h,b,y,C,x,T,v,w,B,A,E,M,D,F,$,O;if(n){for(h=0,y=n.length;y>h;h++)if(w=n[h],x=(null!=(A=w.mimeType)?A:"").toLowerCase(),-1===x.indexOf("multipart"))if(-1===x.indexOf("message/rfc822"))if(B=w.rawHeaders,c=-1!==B.indexOf("Content-Disposition: attachment"),o=w.rawBody,l=/text\/html/.test(x),m=/text\/plain/.test(x),d=/image/.test(x),s=/audio/.test(x),c||d||s){for(g=/Content-Transfer-Encoding: quoted-printable/i.test(B),g&&(o=t.QPDec(o),o=btoa?btoa(o):Base64.encode(o)),E=w.contentTypeParts,b=0,C=E.length;C>b;b++)if(O=E[b],/name=/i.test(O)){T=O.replace(/(.*)=/,"").replace(/"|'/g,"");break}T||(T=d?"image":s?"audio":"attachment",T+="_"+Math.floor(100*Math.random()),F=x.indexOf("/"),$=x.substring(F+1),$.length<4&&(T+="."+$)),D=/(.*)content-id:(.*)<(.*)>/i,u={type:x,base64:o,name:T,cid:null!=(M=D.exec(B))?M[3]:void 0,visible:/png|jpeg|jpg|gif/.test(x)},f.attaches.push(u)}else l||m?(o=a(o,B),o=t.decode(o,w.contentType),l&&(f.html+=o),m&&(f.text+=o)):console.log("Unknown mime type: "+x);else v=e(w.rawBody),i=r(v),f.innerMsgs.push(i);else p(w.bodyParts);return null}};try{if(d=n.messageParts,!d)return f;l=(d.mimeType||"").toLowerCase(),c=/text\/plain/.test(l),i=/text\/html/.test(l),-1!==l.indexOf("multipart")?p(d.bodyParts):c||i?(u=a(d.body,d.rawHeaders),u=t.decode(u,d.contentType),i&&(f.html=u),c&&(f.text=u)):console.log("Warning: mime type isn't supported! mime="+l)}catch(h){throw o=h,new Error(o)}return g=function(e){return"<pre>"+t.toHtmlEntity(e)+"</pre>"},s=function(e){var n,r,u,a,o,i,c,l;if(u=e.innerMsgs,null!=u?u.length:void 0)for(!t.trim(e.html)&&e.text&&(e.html+=g(e.text)),a=0,o=u.length;o>a;a++)r=u[a],i=s(r),l=i.text,n=i.html,n?e.html+=n:l&&(e.html+=wrapPerTag(l),e.text+=l),(null!=(c=i.attaches)?c.length:void 0)>0&&(e.attaches=e.attaches.concat(i.attaches));return e},m=s(f)},r=function(t){var r,u;return u=e(t),r=n(u)},{toMimeTxt:u,toMimeObj:r}}()}).call(this);